{% extends "base.html" %}
{% load static %}

{% block title %}{{ media.title }}{% endblock %}

{% block extra_head %}
<style>
.status-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    border: 1px solid;
    white-space: nowrap;
}

.status-badge.wanted {
    background-color: #e8f4f8;
    color: #417690;
    border-color: #417690;
}

.status-badge.searching {
    background-color: #fff3cd;
    color: #856404;
    border-color: #ffc107;
}

.status-badge.downloading {
    background-color: #d1ecf1;
    color: #0c5460;
    border-color: #17a2b8;
}

.status-badge.downloaded {
    background-color: #d4edda;
    color: #155724;
    border-color: #28a745;
}

.status-badge.failed {
    background-color: #f8d7da;
    color: #721c24;
    border-color: #dc3545;
}

.status-badge.blacklisted {
    background-color: #e2e3e5;
    color: #383d41;
    border-color: #6c757d;
}

.status-badge.pending,
.status-badge.sent {
    background-color: #fff3cd;
    color: #856404;
    border-color: #ffc107;
}

.status-badge.archived {
    background-color: #e2e3e5;
    color: #383d41;
    border-color: #6c757d;
}

.detail-section {
    margin-bottom: 30px;
}

.detail-section h3 {
    margin-top: 0;
    border-bottom: 2px solid #417690;
    padding-bottom: 8px;
    color: #417690;
}

.detail-row {
    display: flex;
    margin-bottom: 12px;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.detail-label {
    font-weight: bold;
    min-width: 150px;
    color: #666;
}

.detail-value {
    flex: 1;
}

.cover-image {
    max-width: 300px;
    max-height: 450px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 20px;
}

.back-link {
    display: inline-block;
    margin-bottom: 20px;
    color: #417690;
    text-decoration: none;
}

.back-link:hover {
    text-decoration: underline;
}
</style>
{% endblock %}

{% block content %}
<a href="{% url 'media:library' %}" class="back-link">‚Üê Back to Library</a>

<h1>{{ media.title }}</h1>

<div class="module" style="margin-bottom: 20px;">
    <button id="search-btn" class="button" style="margin-right: 10px;">Search for Downloads</button>
    <button id="refresh-status-btn" class="button" style="display: none;">Refresh Status</button>
    <div id="search-loading" style="display: none; color: #6c757d; font-style: italic; margin-top: 10px;">Searching...</div>
    <div id="search-error" style="display: none; color: #dc3545; margin-top: 10px;"></div>
</div>

<div id="search-results-section" class="module" style="display: none; margin-bottom: 20px;">
    <h3>Search Results</h3>
    <div id="search-results-container"></div>
</div>

<div id="download-attempts-section" class="module" style="margin-bottom: 20px;">
    <h3>Download Attempts</h3>
    {% if download_attempts %}
        <table id="download-attempts-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #f5f5f5;">
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Release Title</th>
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Indexer</th>
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Status</th>
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Progress</th>
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Attempted</th>
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for attempt in download_attempts %}
                <tr data-attempt-id="{{ attempt.id }}" style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px;">{{ attempt.release_title }}</td>
                    <td style="padding: 10px;">{{ attempt.indexer }}</td>
                    <td style="padding: 10px;">
                        <span class="status-badge {{ attempt.status }}">{{ attempt.get_status_display }}</span>
                    </td>
                    <td style="padding: 10px;">
                        <div class="progress-container" data-attempt-id="{{ attempt.id }}">
                            {% if attempt.status == "downloading" %}
                                <div class="progress-bar" style="width: 0%; background-color: #17a2b8; height: 20px; border-radius: 4px;"></div>
                            {% else %}
                                -
                            {% endif %}
                        </div>
                    </td>
                    <td style="padding: 10px;">{{ attempt.attempted_at|date:"M j, Y g:i A" }}</td>
                    <td style="padding: 10px;">
                        {% if attempt.status == "failed" %}
                            <button class="blacklist-btn button" data-attempt-id="{{ attempt.id }}" style="margin-right: 5px;">Blacklist</button>
                        {% endif %}
                        <button class="delete-attempt-btn button" data-attempt-id="{{ attempt.id }}">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p style="color: #6c757d;">No download attempts yet.</p>
    {% endif %}
</div>

<div class="module">
    <div class="detail-section">
        <h3>Basic Information</h3>
        
        <div class="detail-row">
            <div class="detail-label">Type:</div>
            <div class="detail-value">{{ media_type_display }}</div>
        </div>
        
        <div class="detail-row">
            <div class="detail-label">Status:</div>
            <div class="detail-value">
                <span class="status-badge {{ media.status }}">{{ media.get_status_display }}</span>
            </div>
        </div>
        
        <div class="detail-row">
            <div class="detail-label">Title:</div>
            <div class="detail-value">{{ media.title }}</div>
        </div>
        
        {% if media.sort_title and media.sort_title != media.title %}
        <div class="detail-row">
            <div class="detail-label">Sort Title:</div>
            <div class="detail-value">{{ media.sort_title }}</div>
        </div>
        {% endif %}
        
        <div class="detail-row">
            <div class="detail-label">Authors:</div>
            <div class="detail-value">{{ media.authors|join:", "|default:"-" }}</div>
        </div>
        
        {% if media.series %}
        <div class="detail-row">
            <div class="detail-label">Series:</div>
            <div class="detail-value">
                {{ media.series }}{% if media.series_index %} #{{ media.series_index }}{% endif %}
            </div>
        </div>
        {% endif %}
        
        {% if media.description %}
        <div class="detail-row">
            <div class="detail-label">Description:</div>
            <div class="detail-value">{{ media.description|linebreaks }}</div>
        </div>
        {% endif %}
    </div>
    
    <div class="detail-section">
        <h3>Publication Details</h3>
        
        {% if media.publisher %}
        <div class="detail-row">
            <div class="detail-label">Publisher:</div>
            <div class="detail-value">{{ media.publisher }}</div>
        </div>
        {% endif %}
        
        {% if media.publication_date %}
        <div class="detail-row">
            <div class="detail-label">Publication Date:</div>
            <div class="detail-value">{{ media.publication_date|date:"F Y" }}</div>
        </div>
        {% endif %}
        
        {% if media.language %}
        <div class="detail-row">
            <div class="detail-label">Language:</div>
            <div class="detail-value">{{ media.language }}</div>
        </div>
        {% endif %}
        
        {% if media_type == "book" %}
            {% if media.isbn %}
            <div class="detail-row">
                <div class="detail-label">ISBN:</div>
                <div class="detail-value">{{ media.isbn }}</div>
            </div>
            {% endif %}
            
            {% if media.isbn13 %}
            <div class="detail-row">
                <div class="detail-label">ISBN-13:</div>
                <div class="detail-value">{{ media.isbn13 }}</div>
            </div>
            {% endif %}
            
            {% if media.page_count %}
            <div class="detail-row">
                <div class="detail-label">Page Count:</div>
                <div class="detail-value">{{ media.page_count }}</div>
            </div>
            {% endif %}
            
            {% if media.edition %}
            <div class="detail-row">
                <div class="detail-label">Edition:</div>
                <div class="detail-value">{{ media.edition }}</div>
            </div>
            {% endif %}
        {% endif %}
        
        {% if media_type == "audiobook" %}
            {% if media.narrators %}
            <div class="detail-row">
                <div class="detail-label">Narrators:</div>
                <div class="detail-value">{{ media.narrators|join:", " }}</div>
            </div>
            {% endif %}
            
            {% if duration_formatted %}
            <div class="detail-row">
                <div class="detail-label">Duration:</div>
                <div class="detail-value">{{ duration_formatted }}</div>
            </div>
            {% endif %}
            
            {% if media.bitrate %}
            <div class="detail-row">
                <div class="detail-label">Bitrate:</div>
                <div class="detail-value">{{ media.bitrate }} kbps</div>
            </div>
            {% endif %}
            
            {% if media.chapters %}
            <div class="detail-row">
                <div class="detail-label">Chapters:</div>
                <div class="detail-value">{{ media.chapters }}</div>
            </div>
            {% endif %}
        {% endif %}
    </div>
    
    {% if media.genres or media.tags %}
    <div class="detail-section">
        <h3>Categories</h3>
        
        {% if media.genres %}
        <div class="detail-row">
            <div class="detail-label">Genres:</div>
            <div class="detail-value">{{ media.genres|join:", " }}</div>
        </div>
        {% endif %}
        
        {% if media.tags %}
        <div class="detail-row">
            <div class="detail-label">Tags:</div>
            <div class="detail-value">{{ media.tags|join:", " }}</div>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    {% if media.rating %}
    <div class="detail-section">
        <h3>Rating</h3>
        
        <div class="detail-row">
            <div class="detail-label">Rating:</div>
            <div class="detail-value">{{ media.rating }}/10</div>
        </div>
    </div>
    {% endif %}
    
    <div class="detail-section">
        <h3>Metadata</h3>
        
        {% if media.cover_url %}
        <div class="detail-row">
            <div class="detail-label">Cover:</div>
            <div class="detail-value">
                <img src="{{ media.cover_url }}" alt="Cover" class="cover-image">
            </div>
        </div>
        {% endif %}
        
        <div class="detail-row">
            <div class="detail-label">Provider:</div>
            <div class="detail-value">{{ media.provider|default:"-" }}</div>
        </div>
        
        <div class="detail-row">
            <div class="detail-label">External ID:</div>
            <div class="detail-value">{{ media.external_id|default:"-" }}</div>
        </div>
        
        <div class="detail-row">
            <div class="detail-label">Added Date:</div>
            <div class="detail-value">{{ media.added_date|date:"F j, Y g:i A" }}</div>
        </div>
        
        <div class="detail-row">
            <div class="detail-label">Created:</div>
            <div class="detail-value">{{ media.created_at|date:"F j, Y g:i A" }}</div>
        </div>
        
        <div class="detail-row">
            <div class="detail-label">Last Updated:</div>
            <div class="detail-value">{{ media.updated_at|date:"F j, Y g:i A" }}</div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
const mediaId = "{{ media.id }}";
const mediaType = "{{ media_type }}";

const searchBtn = document.getElementById("search-btn");
if (!searchBtn) {
    console.error("Search button not found");
    return;
}

searchBtn.addEventListener("click", async function() {
    const btn = this;
    const loadingDiv = document.getElementById("search-loading");
    const errorDiv = document.getElementById("search-error");
    const resultsSection = document.getElementById("search-results-section");
    const resultsContainer = document.getElementById("search-results-container");
    
    btn.disabled = true;
    loadingDiv.style.display = "block";
    errorDiv.style.display = "none";
    resultsSection.style.display = "none";
    
    try {
        const response = await fetch(`/api/downloads/search/${mediaId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")
            }
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || "Search failed");
        }
        
        if (data.results && data.results.length > 0) {
            displaySearchResults(data.results);
            resultsSection.style.display = "block";
        } else {
            resultsContainer.innerHTML = "<p>No results found.</p>";
            resultsSection.style.display = "block";
        }
    } catch (error) {
        errorDiv.textContent = `Error: ${error.message}`;
        errorDiv.style.display = "block";
    } finally {
        btn.disabled = false;
        loadingDiv.style.display = "none";
    }
});

function displaySearchResults(results) {
    const container = document.getElementById("search-results-container");
    let html = `
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #f5f5f5;">
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Release Title</th>
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Indexer</th>
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Size</th>
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Seeders</th>
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Actions</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    results.forEach(result => {
        const sizeMB = result.size ? (result.size / 1024 / 1024).toFixed(2) + " MB" : "-";
        const resultData = JSON.stringify(result).replace(/"/g, '&quot;');
        html += `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 10px;">${escapeHtml(result.title)}</td>
                <td style="padding: 10px;">${escapeHtml(result.indexer)}</td>
                <td style="padding: 10px;">${sizeMB}</td>
                <td style="padding: 10px;">${result.seeders || "-"}</td>
                <td style="padding: 10px;">
                    <button class="download-btn button" 
                            data-indexer-id="${result.indexer_id}" 
                            data-guid="${escapeHtml(result.guid)}"
                            data-result='${resultData}'
                            style="background-color: #417690; color: white; border: 1px solid #417690; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                        Download
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    container.innerHTML = html;
    
    document.querySelectorAll(".download-btn").forEach(btn => {
        btn.addEventListener("click", async function() {
            const indexerId = this.dataset.indexerId;
            const guid = this.dataset.guid;
            await initiateDownload(indexerId, guid, this);
        });
    });
}

async function initiateDownload(indexerId, guid, btn) {
    btn.disabled = true;
    btn.textContent = "Initiating...";
    
    const resultData = btn.dataset.result ? JSON.parse(btn.dataset.result) : null;
    
    try {
        const response = await fetch("/api/downloads/initiate/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: JSON.stringify({
                media_id: mediaId,
                indexer_id: parseInt(indexerId),
                guid: guid,
                result: resultData
            })
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.error || "Download initiation failed");
        }
        
        alert("Download initiated successfully!");
        window.location.reload();
    } catch (error) {
        alert(`Error: ${error.message}`);
        btn.disabled = false;
        btn.textContent = "Download";
    }
}

document.querySelectorAll(".delete-attempt-btn").forEach(btn => {
    btn.addEventListener("click", async function() {
        const attemptId = this.dataset.attemptId;
        if (!confirm("Are you sure you want to delete this download attempt?")) {
            return;
        }
        
        try {
            const response = await fetch(`/api/downloads/attempt/${attemptId}/`, {
                method: "DELETE",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken")
                }
            });
            
            const data = await response.json();
            
            if (!response.ok || !data.success) {
                throw new Error(data.error || "Deletion failed");
            }
            
            window.location.reload();
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    });
});

document.querySelectorAll(".blacklist-btn").forEach(btn => {
    btn.addEventListener("click", async function() {
        const attemptId = this.dataset.attemptId;
        if (!confirm("Are you sure you want to blacklist this release?")) {
            return;
        }
        
        try {
            const response = await fetch("/api/downloads/blacklist/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: JSON.stringify({
                    attempt_id: attemptId,
                    reason: "manual"
                })
            });
            
            const data = await response.json();
            
            if (!response.ok || !data.success) {
                throw new Error(data.error || "Blacklist failed");
            }
            
            alert("Release blacklisted successfully!");
            window.location.reload();
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    });
});

const refreshStatusBtn = document.getElementById("refresh-status-btn");
if (refreshStatusBtn) {
    refreshStatusBtn.addEventListener("click", async function() {
        const downloadingRows = document.querySelectorAll("tr[data-attempt-id]");
        for (const row of downloadingRows) {
            const attemptId = row.dataset.attemptId;
            const statusBadge = row.querySelector(".status-badge");
            if (statusBadge && statusBadge.classList.contains("downloading")) {
                await updateDownloadStatus(attemptId, row);
            }
        }
    });
}

async function updateDownloadStatus(attemptId, row) {
    try {
        const response = await fetch(`/api/downloads/attempt/${attemptId}/status/`);
        const data = await response.json();
        
        if (response.ok && data.status) {
            const statusBadge = row.querySelector(".status-badge");
            const progressContainer = row.querySelector(".progress-container");
            
            if (statusBadge) {
                statusBadge.className = `status-badge ${data.status}`;
                statusBadge.textContent = data.status_display || data.status;
            }
            
            if (progressContainer && data.progress !== undefined) {
                const progressBar = progressContainer.querySelector(".progress-bar");
                if (progressBar) {
                    progressBar.style.width = `${data.progress}%`;
                }
            }
            
            if (data.status === "downloaded" || data.status === "failed") {
                window.location.reload();
            }
        }
    } catch (error) {
        console.error("Error updating download status:", error);
    }
}

function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const downloadingAttempts = document.querySelectorAll("tr[data-attempt-id] .status-badge.downloading");
if (downloadingAttempts.length > 0) {
    const refreshBtn = document.getElementById("refresh-status-btn");
    if (refreshBtn) {
        refreshBtn.style.display = "inline-block";
    }
    setInterval(() => {
        document.querySelectorAll("tr[data-attempt-id]").forEach(row => {
            const statusBadge = row.querySelector(".status-badge");
            if (statusBadge && statusBadge.classList.contains("downloading")) {
                const attemptId = row.dataset.attemptId;
                updateDownloadStatus(attemptId, row);
            }
        });
    }, 5000);
}
});
</script>
{% endblock %}

